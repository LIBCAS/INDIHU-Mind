<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">
    <property name="now" value="sysdate" dbms="oracle"/>
    <property name="now" value="getDate()" dbms="mssql"/>
    <property name="now" value="now()" dbms="mysql"/>
    <property name="now" value="now()" dbms="postgresql"/>
    <include file="dbchangelog.core.xml"/>
    <changeSet id="1" author="tomasek">
        <createTable tableName="vzb_user">
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_user_pkey" nullable="false"/>
            </column>
            <column name="email" type="nvarchar(255)">
                <constraints unique="true"/>
            </column>
            <column name="password" type="nvarchar(255)"/>
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime"/>
            <column name="deleted" type="datetime"/>
            <column name="allowed" type="boolean"/>
        </createTable>

        <createTable tableName="vzb_card">
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_card_pkey" nullable="false"/>
            </column>
            <column name="owner_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_card_owner_fk"
                             referencedTableName="vzb_user" referencedColumnNames="id" deleteCascade="true"/>
            </column>
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime"/>
            <column name="deleted" type="datetime"/>
            <column name="pid" type="bigint"/>
            <column name="name" type="nvarchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="note" type="nvarchar(2000)"/> <!-- changed to 'raw_note' change set 14 and added LAZY 'card_note' entity in change set 15 -->
        </createTable>
        <addUniqueConstraint constraintName="vzb_pid_of_user_uniqueness" tableName="vzb_card"
                             columnNames="pid,owner_id"/>

        <createTable tableName="vzb_card_content">
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_card_content_pkey" nullable="false"/>
            </column>
            <column name="origin_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_card_content_origin_fk"
                             referencedTableName="vzb_card_content" referencedColumnNames="id"/>
            </column>
            <column name="card_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_card_content_card_fk"
                             referencedTableName="vzb_card" referencedColumnNames="id" deleteCascade="true"/>
            </column>
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime"/>
            <column name="deleted" type="datetime"/>
            <column name="last_version" type="boolean"/>
        </createTable>

        <createTable tableName="vzb_category">
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_category_pkey" nullable="false"/>
            </column>
            <column name="name" type="nvarchar(255)"/>
            <column name="owner_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_category_owner_fk"
                             referencedTableName="vzb_user" referencedColumnNames="id" deleteCascade="true"/>
            </column>
            <column name="parent_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_category_parent_fk"
                             referencedTableName="vzb_category" referencedColumnNames="id" deleteCascade="true"/>
            </column>
            <column name="ordinal_number" type="int">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addUniqueConstraint constraintName="vzb_category_of_user_uniqueness" tableName="vzb_category"
                             columnNames="name,parent_id,owner_id"/>

        <createTable tableName="vzb_label">
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_label_pkey" nullable="false"/>
            </column>
            <column name="owner_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_label_owner_fk"
                             referencedTableName="vzb_user" referencedColumnNames="id" deleteCascade="true"/>
            </column>
            <column name="name" type="nvarchar(255)"/>
            <column name="color" type="varchar(255)"/>
        </createTable>
        <addUniqueConstraint constraintName="vzb_label_of_user_uniqueness" tableName="vzb_label"
                             columnNames="name,owner_id"/>

        <createTable tableName="vzb_attribute">
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_attribute_pkey" nullable="false"/>
            </column>
            <column name="card_content_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_atr_card_content_fk"
                             referencedTableName="vzb_card_content" referencedColumnNames="id"
                             deleteCascade="true"/>
            </column>
            <column name="ordinal_number" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="nvarchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="json_value" type="text"/>
        </createTable>

        <!--jointables-->
        <createTable tableName="vzb_card_category">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="vzb_card_category_pkey" nullable="false"/>
            </column>
            <column name="card_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_card_category_card_fk"
                             referencedTableName="vzb_card" referencedColumnNames="id" deleteCascade="true"/>
            </column>
            <column name="category_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_card_category_category_fk"
                             referencedTableName="vzb_category" referencedColumnNames="id" deleteCascade="true"/>
            </column>
        </createTable>
        <createTable tableName="vzb_card_label">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="vzb_card_label_pkey" nullable="false"/>
            </column>
            <column name="card_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_card_label_card_fk"
                             referencedTableName="vzb_card" referencedColumnNames="id" deleteCascade="true"/>
            </column>
            <column name="label_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_card_label_label_fk"
                             referencedTableName="vzb_label" referencedColumnNames="id" deleteCascade="true"/>
            </column>
        </createTable>
        <createTable tableName="vzb_card_linked_card">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="vzb_card_linked_card_pkey" nullable="false"/>
            </column>
            <column name="linking_card_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_linking_card_fk"
                             referencedTableName="vzb_card" referencedColumnNames="id" deleteCascade="true"/>
            </column>
            <column name="linked_card_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_linked_card_fk"
                             referencedTableName="vzb_card" referencedColumnNames="id" deleteCascade="true"/>
            </column>
        </createTable>
        <!--/jointables-->
        <!--templates-->
        <createTable tableName="vzb_card_template">
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_card_template_pkey" nullable="false"/>
            </column>
            <column name="owner_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_card_template_owner_fk"
                             referencedTableName="vzb_user" referencedColumnNames="id" deleteCascade="true"/>
            </column>
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime"/>
            <column name="deleted" type="datetime"/>
            <column name="name" type="nvarchar(255)"/>
        </createTable>
        <createTable tableName="vzb_attribute_template">
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_attribute_template_pkey" nullable="false"/>
            </column>
            <column name="card_template_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_atr_template_card_template_fk"
                             referencedTableName="vzb_card_template" referencedColumnNames="id"
                             deleteCascade="true"/>
            </column>
            <column name="type" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="ordinal_number" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="nvarchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="vzb_external_file"> <!-- DELETED in change set #7-->
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_external_file_pkey" nullable="false"/>
            </column>
            <column name="card_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_external_file_card_fk"
                             referencedTableName="vzb_card" referencedColumnNames="id" deleteCascade="true"/>
            </column>
            <column name="name" type="nvarchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="ordinal_number" type="int"/>
            <column name="provider_type" type="varchar(32)"/>
            <column name="link" type="nvarchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="provider_id" type="nvarchar(255)"/>
            <column name="type" type="nvarchar(255)"/>
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime"/>
            <column name="deleted" type="datetime"/>
        </createTable>

        <createTable tableName="vzb_password_token">
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_token_pkey" nullable="false"/>
            </column>
            <column name="expiration_time" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="utilized" type="boolean"/>
            <column name="owner_id" type="varchar(255)">
                <constraints foreignKeyName="id"
                             referencedTableName="vzb_user" referencedColumnNames="id" deleteCascade="true"/>
            </column>
        </createTable>

        <createTable tableName="vzb_local_attachment_file"> <!-- DELETED in change set #7-->
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_local_attachment_file_pkey" nullable="false"/>
            </column>
            <column name="card_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_local_attachment_file_card_fk"
                             referencedTableName="vzb_card" referencedColumnNames="id" deleteCascade="true"/>
            </column>
            <column name="name" type="nvarchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime"/>
            <column name="deleted" type="datetime"/>
            <column name="type" type="nvarchar(255)"/>
            <column name="ordinal_number" type="int"/>
            <column name="content_type" type="varchar(255)"/>
            <column name="size" type="bigint"/>
        </createTable>
    </changeSet>


    <changeSet id="2" author="radvan">
        <!-- MARC RECORD (name, leader) -->
        <createTable tableName="vzb_marc_record"> <!-- DELETED in change set #7-->
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_marc_record_pkey" nullable="false"/>
            </column>
            <column name="owner_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_record_owner_fk"
                             referencedTableName="vzb_user" referencedColumnNames="id" deleteCascade="true"/>
            </column>
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime"/>
            <column name="deleted" type="datetime"/>
            <column name="name" type="nvarchar(255)">
                <constraints nullable="false"/>
            </column>

            <column name="leader" type="varchar(24)"/>
        </createTable>

        <!-- Required constraint because of index on combination name,owner--> <!-- DELETED in change set #7-->
        <addUniqueConstraint constraintName="vzb_record_of_user_uniqueness" tableName="vzb_marc_record"
                             columnNames="name,owner_id"/>

        <!-- MARC DATAFIELD (tag, ind1, ind2) -->
        <createTable tableName="vzb_marc_datafield"> <!-- DELETED in change set #7-->
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_marc_datafield_pkey" nullable="false"/>
            </column>
            <column name="indicator1" type="char"/>
            <column name="indicator2" type="char"/>
            <column name="tag" type="varchar(3)"/>
            <column name="record_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_datafield_record_fk"
                             referencedTableName="vzb_marc_record" referencedColumnNames="id" deleteCascade="true"/>
            </column>
        </createTable>

        <!-- MARC SUBFIELD (code, data) -->
        <createTable tableName="vzb_marc_subfield"> <!-- DELETED in change set #7-->
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_marc_subfield_pkey" nullable="false"/>
            </column>
            <column name="code" type="char"/>
            <column name="data" type="nvarchar(2000)"/>
            <column name="datafield_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_subfield_datafield_fk"
                             referencedTableName="vzb_marc_datafield" referencedColumnNames="id" deleteCascade="true"/>
            </column>
        </createTable>

        <!-- TEMPLATE (name, stringTemplate) -->
        <createTable tableName="vzb_reference_template"> <!-- DELETED in change set #6-->
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_reference_template_pkey" nullable="false"/>
            </column>
            <column name="owner_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_template_owner_fk"
                             referencedTableName="vzb_user" referencedColumnNames="id" deleteCascade="true"/>
            </column>
            <column name="name" type="nvarchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="pattern" type="nvarchar(500)"/>
        </createTable>

        <!-- Required constraint because of index on combination name,owner--> <!-- DELETED in change set #6-->
        <addUniqueConstraint constraintName="vzb_template_of_user_uniqueness" tableName="vzb_reference_template"
                             columnNames="name,owner_id"/>


        <!-- TEMPLATE CUSTOM FIELD (tag, code) -->
        <createTable tableName="vzb_reference_custom_field"> <!-- DELETED in change set #6-->
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_reference_custom_field_pkey" nullable="false"/>
            </column>
            <column name="tag" type="varchar(3)"/>
            <column name="code" type="char"/>

            <column name="template_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_custom_field_template_fk"
                             referencedTableName="vzb_reference_template" referencedColumnNames="id"
                             deleteCascade="true"/>
            </column>
        </createTable>

        <!-- CUSTOMIZATION ENUM TABLE-->
        <createTable tableName="vzb_reference_customization"> <!-- DELETED in change set #6-->
            <column name="custom_field_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_customization_custom_field_fk"
                             referencedTableName="vzb_reference_custom_field" referencedColumnNames="id"
                             deleteCascade="true"/>
            </column>
            <column name="customization" type="varchar(32)"/>
        </createTable>

        <!-- CARD-RECORD JOIN TABLE -->
        <createTable tableName="vzb_card_record"> <!-- DELETED in change set #7-->
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="vzb_card_record_pkey" nullable="false"/>
            </column>
            <column name="card_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_card_record_card_fk"
                             referencedTableName="vzb_card" referencedColumnNames="id" deleteCascade="true"/>
            </column>
            <column name="record_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_card_record_record_fk"
                             referencedTableName="vzb_marc_record" referencedColumnNames="id" deleteCascade="true"/>
            </column>
        </createTable>

    </changeSet>

    <changeSet id="3" author="radvan">
        <addColumn tableName="vzb_reference_template"> <!-- DELETED in change set #6-->
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime"/>
            <column name="deleted" type="datetime"/>
        </addColumn>
    </changeSet>

    <changeSet id="4" author="radvan">
        <createTable tableName="vzb_search_query">
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_search_query_pkey" nullable="false"/>
            </column>

            <column name="owner_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_search_query_owner_fk"
                             referencedTableName="vzb_user" referencedColumnNames="id" deleteCascade="true"/>
            </column>
            <column name="name" type="nvarchar(255)">
                <constraints nullable="false"/>
            </column>

            <column name="indexed_class_name" type="nvarchar(255)"/>
            <column name="parameters" type="nvarchar(4095)"/>


        </createTable>
    </changeSet>

    <changeSet id="5" author="radvan">
        <createTable tableName="vzb_url_attachment_file"> <!-- DELETED in change set #7-->
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_url_attachment_file_pkey" nullable="false"/>
            </column>
            <column name="card_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_url_attachment_file_card_fk"
                             referencedTableName="vzb_card" referencedColumnNames="id" deleteCascade="true"/>
            </column>
            <column name="name" type="nvarchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime"/>
            <column name="deleted" type="datetime"/>

            <column name="link" type="nvarchar(255)">
                <constraints nullable="false"/>
            </column>

            <column name="type" type="nvarchar(255)"/>
            <column name="ordinal_number" type="int"/>
            <column name="content_type" type="varchar(255)"/>
            <column name="size" type="bigint"/>
        </createTable>
    </changeSet>

    <changeSet id="6" author="radvan">
        <!-- DELETE OLD REFERENCE TEMPLATE TABLE -->
        <dropForeignKeyConstraint baseTableName="vzb_reference_customization"
                                  constraintName="vzb_customization_custom_field_fk"/>
        <dropForeignKeyConstraint baseTableName="vzb_reference_custom_field"
                                  constraintName="vzb_custom_field_template_fk"/>
        <dropForeignKeyConstraint baseTableName="vzb_reference_template" constraintName="vzb_template_owner_fk"/>
        <dropUniqueConstraint tableName="vzb_reference_template" constraintName="vzb_template_of_user_uniqueness"/>

        <dropTable tableName="vzb_reference_custom_field" cascadeConstraints="true"/>
        <dropTable tableName="vzb_reference_customization" cascadeConstraints="true"/>
        <dropTable tableName="vzb_reference_template" cascadeConstraints="true"/>

        <!-- CREATE NEW REFERENCE TEMPLATE TABLE AFTER REFACTOR 07/2020 -->
        <!-- TEMPLATE (name, stringTemplate) -->
        <createTable tableName="vzb_reference_template">
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_reference_template_pkey" nullable="false"/>
            </column>
            <column name="owner_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_template_owner_fk"
                             referencedTableName="vzb_user" referencedColumnNames="id" deleteCascade="true"/>
            </column>
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime"/>
            <column name="deleted" type="datetime"/>
            <column name="name" type="nvarchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="fields" type="clob"/>
        </createTable>

        <!-- Required constraint because of index on combination name,owner-->
        <addUniqueConstraint constraintName="vzb_template_of_user_uniqueness" tableName="vzb_reference_template"
                             columnNames="name,owner_id"/>
    </changeSet>

    <changeSet id="7" author="radvan">
        <!-- DELETE OLD RECORD TABLE -->
        <dropForeignKeyConstraint baseTableName="vzb_marc_subfield"
                                  constraintName="vzb_subfield_datafield_fk"/>
        <dropForeignKeyConstraint baseTableName="vzb_marc_datafield"
                                  constraintName="vzb_datafield_record_fk"/>
        <dropForeignKeyConstraint baseTableName="vzb_marc_record"
                                  constraintName="vzb_record_owner_fk"/>
        <dropForeignKeyConstraint baseTableName="vzb_card_record"
                                  constraintName="vzb_card_record_card_fk"/>
        <dropForeignKeyConstraint baseTableName="vzb_card_record"
                                  constraintName="vzb_card_record_record_fk"/>
        <dropUniqueConstraint tableName="vzb_marc_record" constraintName="vzb_record_of_user_uniqueness"/>

        <dropTable tableName="vzb_marc_subfield" cascadeConstraints="true"/>
        <dropTable tableName="vzb_marc_datafield" cascadeConstraints="true"/>
        <dropTable tableName="vzb_marc_record" cascadeConstraints="true"/>
        <dropTable tableName="vzb_card_record" cascadeConstraints="true"/>

        <!-- CREATE NEW RECORD and CARD-RECORD JOIN TABLES after refactor 07/2020 -->
        <!-- MARC RECORD (name, datafields) -->
        <createTable tableName="vzb_marc_record">
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_marc_record_pkey" nullable="false"/>
            </column>
            <column name="owner_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_record_owner_fk"
                             referencedTableName="vzb_user" referencedColumnNames="id" deleteCascade="true"/>
            </column>
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime"/>
            <column name="deleted" type="datetime"/>

            <column name="name" type="nvarchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="data_fields" type="clob"/>
        </createTable>

        <!-- CARD-RECORD JOIN TABLE -->
        <createTable tableName="vzb_card_record">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="vzb_card_record_pkey" nullable="false"/>
            </column>
            <column name="card_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_card_record_card_fk"
                             referencedTableName="vzb_card" referencedColumnNames="id" deleteCascade="true"/>
            </column>
            <column name="record_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_card_record_record_fk"
                             referencedTableName="vzb_marc_record" referencedColumnNames="id" deleteCascade="true"/>
            </column>
        </createTable>

        <!-- Required constraint because of index on combination name,owner-->
        <addUniqueConstraint constraintName="vzb_record_of_user_uniqueness" tableName="vzb_marc_record"
                             columnNames="name,owner_id"/>


        <!-- DELETE OLD ATTACHMENT TABLES -->
        <dropForeignKeyConstraint baseTableName="vzb_local_attachment_file"
                                  constraintName="vzb_local_attachment_file_card_fk"/>

        <dropTable tableName="vzb_local_attachment_file" cascadeConstraints="true"/>

        <dropForeignKeyConstraint baseTableName="vzb_url_attachment_file"
                                  constraintName="vzb_url_attachment_file_card_fk"/>

        <dropTable tableName="vzb_url_attachment_file" cascadeConstraints="true"/>

        <dropForeignKeyConstraint baseTableName="vzb_external_file"
                                  constraintName="vzb_external_file_card_fk"/>

        <dropTable tableName="vzb_external_file" cascadeConstraints="true"/>

        <!-- CHANGED INHERITANCE STRATEGY TO `JOINED` 08/2020 -->
        <createTable tableName="vzb_attachment_abstract">
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_attachment_abstract_pkey" nullable="false"/>
            </column>
            <column name="owner_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_attachment_abstract_owner_fk"
                             referencedTableName="vzb_user" referencedColumnNames="id" deleteCascade="true"/>
            </column>
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime"/>
            <column name="deleted" type="datetime"/>
            <column name="name" type="nvarchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="nvarchar(255)"/>
            <column name="disc_type" type="nvarchar(31)"/>
        </createTable>

        <createTable tableName="vzb_attachment_external">
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_external_attachment_pkey" nullable="false"/>
            </column>
            <column name="provider_type" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="link" type="nvarchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="provider_id" type="nvarchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="vzb_attachment_local">
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_attachment_local_pkey" nullable="false"/>
            </column>
            <column name="content_type" type="varchar(255)"/>
            <column name="size" type="bigint"/>
        </createTable>

        <createTable tableName="vzb_attachment_url">
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_attachment_url_pkey" nullable="false"/>
            </column>
            <column name="link" type="nvarchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="content_type" type="varchar(255)"/>
            <column name="size" type="bigint"/>
        </createTable>

        <!-- CHANGED RELATION CARD-ATTACHMENT TO MANY-TO-MANY 08/2020 -->
        <createTable tableName="vzb_card_attachment">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="vzb_card_attachment_pkey" nullable="false"/>
            </column>
            <column name="card_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_card_attachment_card_fk"
                             referencedTableName="vzb_card" referencedColumnNames="id" deleteCascade="true"/>
            </column>
            <column name="attachment_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_card_attachment_attachment_fk"
                             referencedTableName="vzb_attachment_abstract" referencedColumnNames="id"
                             deleteCascade="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="8" author="radvan">
        <addColumn tableName="vzb_marc_record">
            <column name="document_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_record_attachment_fk"
                             referencedTableName="vzb_attachment_abstract" referencedColumnNames="id"
                             deleteCascade="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="9" author="radvan">
        <!-- DELETE OLD RECORD TABLE TO ALLOW INTRODUCTION OF CITATION (ABSTRACT CLASS) 09/2020 -->
        <dropForeignKeyConstraint baseTableName="vzb_marc_record"
                                  constraintName="vzb_record_owner_fk"/>
        <dropForeignKeyConstraint baseTableName="vzb_card_record"
                                  constraintName="vzb_card_record_card_fk"/>
        <dropForeignKeyConstraint baseTableName="vzb_card_record"
                                  constraintName="vzb_card_record_record_fk"/>
        <dropUniqueConstraint tableName="vzb_marc_record" constraintName="vzb_record_of_user_uniqueness"/>

        <dropTable tableName="vzb_marc_record" cascadeConstraints="true"/>
        <dropTable tableName="vzb_card_record" cascadeConstraints="true"/>

        <!-- INTRODUCED `JOINED` INHERITANCE STRATEGY 09/2020 -->
        <createTable tableName="vzb_marc_citation_abstract"> <!-- RENAMED in change set #12  10/2020 -->
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_citation_abstract_pkey" nullable="false"/>
            </column>
            <column name="owner_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_citation_abstract_owner_fk"
                             referencedTableName="vzb_user" referencedColumnNames="id" deleteCascade="true"/>
            </column>
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime"/>
            <column name="deleted" type="datetime"/>
            <column name="name" type="nvarchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="disc_type" type="nvarchar(31)"/> <!-- REMOVED in change set #12  10/2020 -->

            <column name="document_id" type="varchar(255)"> <!-- REMOVED in change set #10  09/2020 -->
                <constraints foreignKeyName="vzb_citation_attachment_fk"
                             referencedTableName="vzb_attachment_abstract" referencedColumnNames="id"
                             deleteCascade="false"/>
            </column>
        </createTable>

        <addUniqueConstraint constraintName="vzb_citation_of_user_uniqueness"
                             tableName="vzb_marc_citation_abstract"
                             columnNames="name,owner_id"/>

        <createTable tableName="vzb_marc_record">
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_marc_record_pkey" nullable="false"/>
            </column>
            <column name="data_fields" type="clob"/>
        </createTable>

        <createTable tableName="vzb_marc_brief_record">
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_marc_brief_record_pkey" nullable="false"/>
            </column>
            <column name="content" type="clob"/>
        </createTable>

        <createTable tableName="vzb_card_citation">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="vzb_card_citation_pkey" nullable="false"/>
            </column>
            <column name="card_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_card_citation_card_fk"
                             referencedTableName="vzb_card" referencedColumnNames="id" deleteCascade="true"/>
            </column>
            <column name="citation_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_card_citation_citation_fk"
                             referencedTableName="vzb_marc_citation_abstract" referencedColumnNames="id"
                             deleteCascade="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="10" author="radvan">
        <!-- CHANGED RELATION CITATION-DOCUMENT TO MANY-TO-MANY 09/2020 -->
        <dropForeignKeyConstraint baseTableName="vzb_marc_citation_abstract"
                                  constraintName="vzb_citation_attachment_fk"/>
        <dropColumn tableName="vzb_marc_citation_abstract" columnName="document_id"/>

        <createTable tableName="vzb_citation_document">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="vzb_citation_document_pkey" nullable="false"/>
            </column>
            <column name="citation_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_citation_document_citation_fk"
                             referencedTableName="vzb_marc_citation_abstract" referencedColumnNames="id"
                             deleteCascade="true"/>
            </column>
            <column name="document_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_citation_document_document_fk"
                             referencedTableName="vzb_attachment_abstract" referencedColumnNames="id"
                             deleteCascade="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="11" author="radvan">
        <addColumn tableName="vzb_attachment_url">
            <column name="location" type="nvarchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="12" author="radvan">
        <dropTable tableName="vzb_marc_record"/>
        <dropTable tableName="vzb_marc_brief_record"/>
        <dropColumn tableName="vzb_marc_citation_abstract" columnName="disc_type"/>
        <addColumn tableName="vzb_marc_citation_abstract">
            <column name="data_fields" type="clob"/>
            <column name="content" type="clob"/>
        </addColumn>
        <renameTable oldTableName="vzb_marc_citation_abstract" newTableName="vzb_marc_citation"/>
    </changeSet>

    <changeSet id="13" author="radvan">
        <modifyDataType tableName="vzb_card" columnName="note" newDataType="clob"/>
    </changeSet>
    <changeSet id="14" author="radvan">
        <createTable tableName="vzb_card_comment">
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_card_comment_pkey" nullable="false"/>
            </column>
            <column name="card_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_comment_card_fk"
                             referencedTableName="vzb_card" referencedColumnNames="id" deleteCascade="true"/>
            </column>
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime"/>
            <column name="deleted" type="datetime"/>
            <column name="text" type="clob"/>
            <column name="text_updated" type="datetime"/>
            <column name="ordinal_number" type="int">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addColumn tableName="vzb_card">
            <column name="raw_note" type="clob"/>
        </addColumn>
    </changeSet>

    <changeSet id="15" author="radvan">
        <dropColumn tableName="vzb_card" columnName="note" />

        <createTable tableName="vzb_card_note">
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="vzb_card_note_pkey" nullable="false"/>
            </column>
            <column name="data" type="clob"/>
            <column name="size" type="bigint"/>
        </createTable>

        <addColumn tableName="vzb_card">
            <column name="note_id" type="varchar(255)">
                <constraints foreignKeyName="vzb_card_note_fk"
                             referencedTableName="vzb_card_note"
                             referencedColumnNames="id"
                             deleteCascade="true"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet id="16" author="radvan">
        <addColumn tableName="vzb_label">
            <column name="ordinal_number" type="int" value="0">
                <!-- <constraints nullable="false"/>-->
            </column>
        </addColumn>
        <!-- Workaround, because its not possible to create new not null column even though the value="0" is set -->
        <addNotNullConstraint tableName="vzb_label" columnName="ordinal_number" />
    </changeSet>
    <changeSet id="17" author="radvan">
        <addColumn tableName="vzb_card">
            <column name="status" type="varchar(255)">
                <!-- not null constraint add after data migration -->
            </column>
        </addColumn>
        <!-- If card was in trash bin, set value of new column to 'TRASHED' otherwise set 'AVAILABLE' -->
        <!-- Change all .deleted values to NULL (.deleted used to declare that card is in trash bin, but .status is used from now on) -->
        <sql>
            UPDATE vzb_card
            SET status='AVAILABLE'
            WHERE deleted IS NULL;

            UPDATE vzb_card
            SET status='TRASHED'
            WHERE deleted IS NOT NULL;

            UPDATE vzb_card
            SET deleted=NULL
            WHERE deleted IS NOT NULL;
        </sql>
        <addNotNullConstraint tableName="vzb_card" columnName="status" />
    </changeSet>
    <changeSet id="18" author="radvan">
        <createIndex tableName="uas_assigned_role" indexName="assigned_role_user_id_index">
            <column name="user_id"/>
        </createIndex>
    </changeSet>
    <changeSet id="19" author="radvan">
        <addColumn tableName="vzb_attachment_abstract">
            <column name="provider_type" type="varchar(255)" />
            <!-- not null constraint add after data migration -->
        </addColumn>
        <!-- Populate newly created 'provider_type' column with data -->
        <sql>
            UPDATE vzb_attachment_abstract
            SET provider_type='URL'
            WHERE disc_type='URL';

            UPDATE vzb_attachment_abstract
            SET provider_type='LOCAL'
            WHERE disc_type='LOCAL';

            UPDATE vzb_attachment_abstract
            SET provider_type='DROPBOX'
            WHERE disc_type='EXTERNAL' AND id IN (
                SELECT abs.id
                FROM vzb_attachment_abstract as abs INNER JOIN vzb_attachment_external as ext
                ON abs.id = ext.id
                WHERE ext.provider_type='DROPBOX'
            );

            UPDATE vzb_attachment_abstract
            SET provider_type='GOOGLE_DRIVE'
            WHERE disc_type='EXTERNAL' AND id IN (
                SELECT abs.id
                FROM vzb_attachment_abstract as abs INNER JOIN vzb_attachment_external as ext
                ON abs.id = ext.id
                WHERE ext.provider_type='GOOGLE_DRIVE'
            );
        </sql>
        <addNotNullConstraint tableName="vzb_attachment_abstract" columnName="provider_type" />
        <dropColumn tableName="vzb_attachment_external" columnName="provider_type" />
    </changeSet>
    <changeSet id="20" author="radvan">
        <modifyDataType tableName="vzb_attachment_url" columnName="link" newDataType="clob" />
        <modifyDataType tableName="vzb_attachment_external" columnName="link" newDataType="clob" />
        <modifyDataType tableName="vzb_attachment_external" columnName="provider_id" newDataType="clob" />
    </changeSet>
</databaseChangeLog>
